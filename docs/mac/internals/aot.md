---
title: Xamarin. Mac の事前コンパイル
description: このドキュメントでは、Xamarin. Mac での事前コンパイルについて説明します。 AOT のコンパイルと JIT コンパイルを比較し、AOT を有効にする方法について説明し、hybrid AOT を見てみましょう。
ms.prod: xamarin
ms.assetid: 38B8A017-5A58-429C-A6E9-9860A1DCEF63
ms.technology: xamarin-mac
author: conceptdev
ms.author: crdun
ms.date: 11/10/2017
ms.openlocfilehash: 6797428596fddb0361fb307240bf8237a1e8554d
ms.sourcegitcommit: 57f815bf0024b1afe9754c0e28054fc0a53ce302
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/06/2019
ms.locfileid: "70769831"
---
# <a name="xamarinmac-ahead-of-time-compilation"></a>Xamarin. Mac の事前コンパイル

## <a name="overview"></a>概要

事前に (AOT) コンパイルは、起動時のパフォーマンスを向上させるための強力な最適化手法です。 ただし、ビルド時間、アプリケーションサイズ、およびプログラムの実行にも大きな影響を及ぼします。 そのトレードオフについて理解するために、アプリケーションのコンパイルと実行について少し詳しく説明します。

C#やF#などのマネージ言語で記述されたコードは、IL と呼ばれる中間表現にコンパイルされます。 ライブラリおよびプログラムアセンブリに格納されているこの IL は、プロセッサアーキテクチャ間で比較的コンパクトで移植性があります。 ただし、IL は命令の中間セットであり、ある時点で、IL はプロセッサに固有のマシンコードに変換する必要があります。

この処理を行うには、次の2つの点があります。

- **ジャストインタイム (JIT)** –アプリケーションの起動時および実行時に、IL はメモリ内でコンピューターコードにコンパイルされます。
- **事前に (AOT)** –ビルド中、IL はコンパイルされ、ネイティブライブラリに書き込まれ、アプリケーションバンドル内に格納されます。

各オプションには、いくつかの利点とトレードオフがあります。

- **JIT**
  - **起動時間**– JIT コンパイルは起動時に実行する必要があります。 ほとんどのアプリケーションでは、これは100ミリ秒の順序になっていますが、大規模なアプリケーションの場合は、この時間が大幅に長くなる可能性があります。
  - **実行**–使用される特定のプロセッサに合わせて JIT コードを最適化できるため、コードを少し改善することができます。 ほとんどのアプリケーションでは、これはほとんどの場合、数パーセントのポイントになります。
- **AOT**
  - **起動時間**–プリコンパイル済みの用 dylib の読み込みは、JIT アセンブリよりも大幅に高速です。
  - **ディスク領域**-これらの用 dylib は、大量のディスク領域を消費する可能性があります。 再作成されるアセンブリに応じて、アプリケーションのコード部分のサイズを2倍以上にすることができます。
  - **ビルド時間**– AOT のコンパイルは JIT で大幅に遅くなり、それを使用してビルドが遅くなります。 この速度の低下は、コンパイルされたアセンブリのサイズと数に応じて、数秒から1分以上の範囲になります。
  - **難読**化–機械語コードよりもリバースエンジニアリングが非常に簡単な IL であるため、必ずしも必要ではありません。これは、機密コードを難読化するために取り除くことができるということではありません。 これには、以下の "ハイブリッド" オプションに関する説明が必要です。

## <a name="enabling-aot"></a>AOT の有効化

AOT オプションは、今後の更新プログラムで Mac ビルドウィンドウに追加されます。 それまでは、AOT を有効にするには、Mac ビルドの "追加の mmp 引数" フィールドを使用してコマンドライン引数を渡す必要があります。 次のようなオプションがあります。

```
--aot[=VALUE]          Specify assemblies that should be AOT compiled
                          - none - No AOT (default)
                          - all - Every assembly in MonoBundle
                          - core - Xamarin.Mac, System, mscorlib
                          - sdk - Xamarin.Mac.dll and BCL assemblies
                          - |hybrid after option enables hybrid AOT which
                          allows IL stripping but is slower (only valid
                          for 'all')
                          - Individual files can be included for AOT via +
                          FileName.dll and excluded via -FileName.dll

                          Examples:
                            --aot:all,-MyAssembly.dll
                            --aot:core,+MyOtherAssembly.dll,-mscorlib.dll
```

## <a name="hybrid-aot"></a>Hybrid AOT

MacOS アプリケーションの実行中、ランタイムは既定で AOT コンパイルによって生成されたネイティブライブラリから読み込まれたマシンコードを使用します。 ただし、trampolines などのコードの一部では、JIT コンパイルによってより最適化された結果が生成されます。 これには、マネージアセンブリ IL が使用可能である必要があります。 IOS では、アプリケーションは JIT コンパイルの使用によって制限されます。これらのコードセクションは AOT でもコンパイルされています。

ハイブリッドオプションは、これらのセクション (iOS など) をコンパイルするようにコンパイラに指示しますが、実行時に IL が使用できなくなることを前提としています。 この IL は、ビルド後に削除できます。 前述のように、ランタイムはいくつかの場所で、より最適化されていないルーチンを使用するように強制されます。

## <a name="further-considerations"></a>その他の注意事項

処理されるアセンブリのサイズと数によって、AOT スケールの結果が負の値になります。 たとえば、完全な[ターゲットフレームワーク](~/mac/platform/target-framework.md)には、現代よりもかなり大きな基底クラスライブラリ (BCL) が含まれているため、AOT はかなり長くなり、より大きなバンドルが生成されます。 これは、完全なターゲットフレームワークとリンクの互換性がないため、未使用のコードが除去されます。 アプリケーションを最新の状態に移行し、最適な結果を得るためのリンクを有効にすることを検討してください。

AOT のもう1つの利点は、ネイティブデバッグとプロファイリングツールチェーンとの対話機能の向上です。 コードベースの大部分は事前にコンパイルされるため、ネイティブのクラッシュレポート、プロファイリング、デバッグの内部で読みやすくなる関数名とシンボルが使用されます。 JIT で生成された関数にはこれらの名前がなく、多くの場合、解決が非常に困難な非名前の16進オフセットとして表示されます。
